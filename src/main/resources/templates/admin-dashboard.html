<!DOCTYPE html>
<html lang="en" dir="ltr" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/png" th:href="@{/images/tts-logo-ev.png}">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title>Admin - Dashboard | TechnoKraft</title>
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css"
          integrity=""
          crossorigin="anonymous">
    <link href="https://unpkg.com/boxicons@2.0.7/css/boxicons.min.css" rel="stylesheet" />
    <link rel="stylesheet" th:href="@{/css/admin-dashboard.css}" />
    <link rel="stylesheet" th:href="@{/css/footer.css}" >
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <style>
        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: #0066cc;
            box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1);
        }

        .form-control.error {
            border-color: #dc3545;
        }

        .form-text {
            display: block;
            margin-top: 5px;
            font-size: 12px;
            color: #666;
        }

        .field-error {
            display: block;
            color: #dc3545;
            font-size: 12px;
            margin-top: 5px;
        }
    </style>

</head>
<body>
<div class="sidebar">
    <div class="logo-details">
        <img th:src="@{/images/tts-logo-ev.png}" alt="tts">
        <span class="logo_name">TechnoKraft<p class="sub-title">Training & Solution PVT. LTD.</p></span>
    </div>
    <ul class="nav-links">
        <li>
            <a href="#" class="active" onclick="showSection('dashboard')">
                <i class="bx bx-grid-alt"></i>
                <span class="links_name">Dashboard</span>
            </a>
        </li>
        <li>
            <a href="#" onclick="showSection('students')">
                <i class="bx bx-user"></i>
                <span class="links_name">Students</span>
            </a>
        </li>
        <li>
            <a href="#" onclick="showSection('create-test')">
                <i class="bx bx-clipboard"></i>
                <span class="links_name">Create Tests</span>
            </a>
        </li>
        <li>
            <a href="#" onclick="showSection('results')">
                <i class="bx bx-file"></i>
                <span class="links_name">Test Results</span>
            </a>
        </li>
        <li>
            <a href="#" onclick="showSection('questions')">
                <i class="bx bx-question-mark"></i>
                <span class="links_name">Question Bank</span>
            </a>
        </li>
        <li>
            <a href="#" onclick="showSection('subjects')">
                <i class="bx bx-book"></i>
                <span class="links_name">Subjects</span>
            </a>
        </li>
        <li>
            <a href="#" onclick="showSection('reports')">
                <i class="bx bx-bar-chart-alt-2"></i>
                <span class="links_name">Analytics</span>
            </a>
        </li>
        <li>
            <a href="#" onclick="event.preventDefault(); alert('Settings page coming soon!')">
                <i class="bx bx-cog"></i>
                <span class="links_name">Settings</span>
            </a>
        </li>
        <li class="log_out">
            <a href="#" onclick="event.preventDefault(); document.getElementById('logoutForm').submit();">
                <i class="bx bx-log-out"></i>
                <span class="links_name">Log out</span>
            </a>
        </li>
    </ul>
</div>

<form id="logoutForm" th:action="@{/logout}" method="post" style="display:none;">
    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
</form>

<section class="home-section">
    <nav>
        <div class="sidebar-button">
            <i class="bx bx-menu sidebarBtn"></i>
            <span class="dashboard">Admin Dashboard</span>
        </div>
        <div class="profile-details" onclick="toggleProfileDropdown()">
            <img th:src="@{/images/default-user.png}" alt="Admin" />
            <span class="admin_name" th:text="${adminName}">Admin</span>
            <i class="bx bx-chevron-down"></i>
            <div class="profile-dropdown" id="profileDropdown">
                <a href="#" onclick="event.preventDefault(); alert('Profile page coming soon!')"><i class="bx bx-user"></i> My Profile</a>
                <a href="#" onclick="event.preventDefault(); alert('Settings page coming soon!')"><i class="bx bx-cog"></i> Settings</a>
                <a href="#" onclick="event.preventDefault(); alert('Help page coming soon!')"><i class="bx bx-help-circle"></i> Help</a>
                <a href="#" onclick="event.preventDefault(); document.getElementById('logoutForm').submit();">
                    <i class="bx bx-log-out"></i> Logout
                </a>
            </div>
        </div>
    </nav>

    <div class="home-content">
        <!-- Error/Success Messages -->
        <div th:if="${error}" class="error-message">
            <i class="bx bx-error-circle"></i>
            <span th:text="${error}">Error message</span>
        </div>
        <div th:if="${success}" class="success-message">
            <i class="bx bx-check-circle"></i>
            <span th:text="${success}">Success message</span>
        </div>

        <!-- Dashboard Section -->
        <div id="dashboard-section" class="section-content">
            <div class="overview-boxes">
                <div class="box">
                    <div class="left-side">
                        <div class="box-topic">Total Students</div>
                        <div class="number" th:text="${dashboardStats.totalStudents}">0</div>
                        <div class="indicator">
                            <i class="bx bx-up-arrow-alt"></i>
                            <span class="text">Up from yesterday</span>
                        </div>
                    </div>
                    <i class="bx bx-user cart"></i>
                </div>
                <div class="box">
                    <div class="left-side">
                        <div class="box-topic">Tests Completed</div>
                        <div class="number" th:text="${dashboardStats.testsCompleted}">0</div>
                        <div class="indicator">
                            <i class="bx bx-up-arrow-alt"></i>
                            <span class="text">Up from yesterday</span>
                        </div>
                    </div>
                    <i class="bx bx-file cart two"></i>
                </div>
                <div class="box">
                    <div class="left-side">
                        <div class="box-topic">Pass Rate</div>
                        <div class="number" th:text="${dashboardStats.passRate + '%'}">0%</div>
                        <div class="indicator">
                            <i class="bx bx-up-arrow-alt"></i>
                            <span class="text">Up from last week</span>
                        </div>
                    </div>
                    <i class="bx bx-trophy cart three"></i>
                </div>
                <div class="box">
                    <div class="left-side">
                        <div class="box-topic">Active Subjects</div>
                        <div class="number" th:text="${dashboardStats.activeSubjects}">0</div>
                        <div class="indicator">
                            <i class="bx bx-up-arrow-alt"></i>
                            <span class="text">New subject added</span>
                        </div>
                    </div>
                    <i class="bx bx-book-open cart four"></i>
                </div>
            </div>
            <div class="content-section">
                <div class="section-header">
                    <h2 class="section-title">Recent Test Results</h2>
                    <button class="btn btn-primary" onclick="showSection('results')">
                        View All <i class="bx bx-right-arrow-alt"></i>
                    </button>
                </div>
                <div class="table-container">
                    <table th:if="${not #lists.isEmpty(recentResults)}">
                        <thead>
                        <tr>
                            <th>Student ID</th>
                            <th>Name</th>
                            <th>Subject</th>
                            <th>Score</th>
                            <th>Status</th>
                            <th>Date</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="result : ${recentResults}">
                            <td th:text="${result.studentId}">STD-001</td>
                            <td th:text="${result.studentName}">Student Name</td>
                            <td th:text="${result.subjectName}">Subject</td>
                            <td th:text="${result.score + '/' + result.totalMarks}">0/100</td>
                            <td>
                                <span class="status-badge"
                                      th:classappend="${result.passed ? 'status-pass' : 'status-fail'}"
                                      th:text="${result.passed ? 'Pass' : 'Fail'}">Pass</span>
                            </td>
                            <td th:text="${#temporals.format(result.testDate, 'MMM dd, yyyy')}">Date</td>
                        </tr>
                        </tbody>
                    </table>
                    <div th:if="${#lists.isEmpty(recentResults)}" class="empty-state">
                        <i class="bx bx-file"></i>
                        <h3>No Test Results Found</h3>
                        <p>There are no recent test results to display</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Students Section -->
        <div id="students-section" class="section-content" style="display: none;">
            <div class="content-section">
                <div class="section-header">
                    <h2 class="section-title">Student Management</h2>
                    <button class="btn btn-primary" onclick="openModal('addStudentModal')">
                        <i class="bx bx-plus"></i> Add New Student
                    </button>
                </div>
                <div class="search-bar">
                    <input type="text"
                           name="query"
                           placeholder="Search by Student ID, Name or Email..."
                           id="studentSearch"
                           onkeyup="searchStudentsLive()">
                    <button class="btn btn-primary" onclick="searchStudentsLive()">
                        <i class="bx bx-search"></i> Search
                    </button>
                    <button class="btn btn-secondary" onclick="clearSearch()" id="clearBtn" style="display: none;">
                        <i class="bx bx-x"></i> Clear
                    </button>
                    <a href="#" onclick="alert('Export functionality coming soon!')" class="btn btn-success">
                        <i class="bx bx-download"></i> Export All
                    </a>
                </div>
                <div class="table-container" id="studentTableContainer">
                    <table th:if="${not #lists.isEmpty(allStudents)}">
                        <thead>
                        <tr>
                            <th>Student ID</th>
                            <th>Full Name</th>
                            <th>Email</th>
                            <th>Registered Date</th>
                            <th>Tests Taken</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                        </thead>
                        <tbody id="studentTableBody">
                        <tr th:each="student : ${allStudents}">
                            <td th:text="${student.studentId}">STD-001</td>
                            <td th:text="${student.fullName}">Student Name</td>
                            <td th:text="${student.email}">email@example.com</td>
                            <td th:text="${#temporals.format(student.registeredDate, 'MMM dd, yyyy')}">Date</td>
                            <td th:text="${student.testsTaken}">0</td>
                            <td>
                        <span class="status-badge"
                              th:classappend="${student.enabled ? 'status-pass' : 'status-fail'}"
                              th:text="${student.enabled ? 'Active' : 'Inactive'}">Active</span>
                            </td>
                            <td>
                                <div class="action-buttons">
<!--                                    <button class="action-btn btn-primary"-->
<!--                                            title="View Details"-->
<!--                                            onclick="alert('View details coming soon!')">-->
<!--                                        <i class="bx bx-show"></i>-->
<!--                                    </button>-->
                                    <button class="action-btn btn-success"
                                            title="Download Report"
                                            onclick="alert('Download report coming soon!')">
                                        <i class="bx bx-download"></i>
                                    </button>
                                    <button class="action-btn btn-danger"
                                            title="Delete"
                                            th:onclick="'deleteStudent(' + ${student.id} + ')'">
                                        <i class="bx bx-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                    <div th:if="${#lists.isEmpty(allStudents)}" class="empty-state" id="emptyState">
                        <i class="bx bx-user"></i>
                        <h3>No Students Yet</h3>
                        <p>Add your first student to get started</p>
                    </div>
                    <!-- Loading indicator -->
                    <div id="loadingIndicator" style="display: none; text-align: center; padding: 20px;">
                        <i class="bx bx-loader-alt bx-spin" style="font-size: 32px;"></i>
                        <p>Searching...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Create Test Section -->

        <div id="create-test-section" class="section-content" style="display: none;">
            <div class="content-section">
                <div class="section-header">
                    <h2 class="section-title">Test Management</h2>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-primary" onclick="openModal('createTestModal')">
                            <i class="bx bx-plus"></i> Create New Test
                        </button>
                        <button class="btn btn-secondary" onclick="window.location.reload()">
                            <i class="bx bx-refresh"></i> Refresh
                        </button>
                    </div>
                </div>

                <!-- Tests Table -->
                <div class="table-container">
                    <table th:if="${not #lists.isEmpty(allTests)}">
                        <thead>
                        <tr>
                            <th>Test Name</th>
                            <th>Subject</th>
                            <th>Type</th>
                            <th>Questions</th>
                            <th>Duration</th>
                            <th>Pass %</th>
                            <th>Total Marks</th>
                            <th>Created Date</th>
                            <th>Actions</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="test : ${allTests}">
                            <!-- Display the auto-generated testName -->
                            <td th:text="${test.testName}">Test Name</td>

                            <!-- Display subject name from DTO -->
                            <td th:text="${test.subjectName}">Subject</td>

                            <!-- Display test type with badge -->
                            <td>
                        <span class="status-badge"
                              th:classappend="${test.testType == 'FINAL' ? 'status-fail' : 'status-pass'}"
                              th:text="${test.testType}">Type</span>
                            </td>

                            <!-- Display total questions -->
                            <td th:text="${test.totalQuestions}">0</td>

                            <!-- Display duration -->
                            <td th:text="${test.duration + ' min'}">0 min</td>

                            <!-- Display passing percentage -->
                            <td th:text="${test.passingPercentage + '%'}">0%</td>

                            <!-- Display total marks -->
                            <td th:text="${test.totalMarks}">0</td>

                            <!-- Display created date -->
                            <td th:text="${#temporals.format(test.createdAt, 'dd MMM yyyy')}">Date</td>

                            <!-- Action buttons -->
                            <td>
                                <div class="action-buttons">
                                    <button class="action-btn btn-primary"
                                            title="View Details"
                                            th:onclick="'viewTestDetails(' + ${test.id} + ')'">
                                        <i class="bx bx-show"></i>
                                    </button>
                                    <button class="action-btn btn-secondary"
                                            title="Edit"
                                            th:onclick="'editTest(' + ${test.id} + ')'">
                                        <i class="bx bx-edit"></i>
                                    </button>
                                    <button class="action-btn btn-danger"
                                            title="Delete"
                                            th:onclick="'deleteTest(' + ${test.id} + ')'">
                                        <i class="bx bx-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                    <div th:if="${#lists.isEmpty(allTests)}" class="empty-state">
                        <i class="bx bx-clipboard"></i>
                        <h3>No Tests Created Yet</h3>
                        <p>Create your first test to get started</p>
                    </div>
                </div>
            </div>
        </div>


        <!-- Create Test Modal -->
        <div id="createTestModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Create New Test</h2>
                    <span class="close" onclick="closeModal('createTestModal')">&times;</span>
                </div>

                <!-- Error Message Display -->
                <div th:if="${testError}" class="error-message" style="margin-bottom: 15px;">
                    <i class="bx bx-error-circle"></i>
                    <span th:text="${testError}">Error</span>
                </div>

                <!-- Show message when no subjects -->
                <div th:if="${subjectsCount == null || subjectsCount == 0}"
                     class="alert alert-warning">
                    <i class="bx bx-error"></i>
                    Please add at least one subject before creating a test.
                </div>

                <!-- Success Message Display -->
                <div th:if="${success != null and #strings.contains(success, 'Test')}"
                     class="success-message" style="margin-bottom: 15px;">
                    <i class="bx bx-check-circle"></i>
                    <span th:text="${success}">Success</span>
                </div>

                <!-- Check if subjects exist -->
                <div th:if="${subjectsCount == 0}"
                     style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin-bottom: 20px; border-radius: 4px;">
                    <h4 style="margin: 0 0 10px 0; color: #856404;">
                        <i class="bx bx-info-circle"></i> No Subjects Available
                    </h4>
                    <p style="margin: 5px 0; font-size: 14px; color: #856404;">
                        You need to create subjects before creating tests.
                    </p>
                    <button class="btn btn-primary"
                            onclick="closeModal('createTestModal'); openModal('addSubjectModal')"
                            style="margin-top: 10px;">
                        <i class="bx bx-plus"></i> Create Subject First
                    </button>
                </div>

                <!-- Create Test Form -->
                <form th:if="${subjectsCount != null && subjectsCount > 0}"
                      th:action="@{/admin/tests/create}"
                      method="post"
                      th:object="${testDTO}">

                    <!-- CSRF Token -->
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

                    <!-- Subject Selection -->
                    <div class="form-group">
                        <label for="subjectName">
                            <i class="bx bx-book"></i> Subject Name *
                        </label>
                        <select id="subjectName"
                                th:field="*{subjectName}"
                                required
                                class="form-control"
                                onchange="updateTestName()">
                            <option value="">-- Select Subject --</option>
                            <option th:each="name : ${subjectTestNames}"
                                    th:value="${name}"
                                    th:text="${name}">
                            </option>
                        </select>
                        <small class="form-text">Choose the subject for this test</small>
                    </div>

                    <!-- Test Type -->
                    <div class="form-group">
                        <label for="testType">
                            <i class="bx bx-category"></i> Test Type *
                        </label>
                        <select id="testType"
                                th:field="*{testType}"
                                required
                                class="form-control"
                                onchange="updateTestName()">
                            <option value="">-- Select Test Type --</option>
                            <option value="FINAL">Final Test</option>
                            <option value="MOCK">Mock Test</option>
                        </select>
                        <small class="form-text">
                            <i class="bx bx-info-circle"></i>
                            Final name: [Subject] + [Mock Test / Final Test]
                        </small>
                    </div>

                    <!-- Total Questions -->
                    <div class="form-group">
                        <label for="totalQuestions">
                            <i class="bx bx-list-ul"></i> Total Questions *
                        </label>
                        <input type="number"
                               id="totalQuestions"
                               th:field="*{totalQuestions}"
                               min="1"
                               max="500"
                               placeholder="e.g., 50"
                               required
                               class="form-control" />
                        <small class="form-text">Minimum 1 question required</small>
                    </div>

                    <!-- Duration -->
                    <div class="form-group">
                        <label for="duration">
                            <i class="bx bx-time"></i> Duration (minutes) *
                        </label>
                        <input type="number"
                               id="duration"
                               th:field="*{duration}"
                               min="5"
                               max="300"
                               placeholder="e.g., 60"
                               required
                               class="form-control" />
                        <small class="form-text">Minimum 5 minutes</small>
                    </div>

                    <!-- Passing Percentage -->
                    <div class="form-group">
                        <label for="passingPercentage">
                            <i class="bx bx-target-lock"></i> Passing Percentage (%) *
                        </label>
                        <input type="number"
                               id="passingPercentage"
                               th:field="*{passingPercentage}"
                               min="1"
                               max="100"
                               placeholder="e.g., 40"
                               required
                               class="form-control" />
                        <small class="form-text">Value between 1-100</small>
                    </div>

                    <!-- Marks per Question -->
                    <div class="form-group">
                        <label for="marksPerQuestion">
                            <i class="bx bx-star"></i> Marks per Question *
                        </label>
                        <input type="number"
                               id="marksPerQuestion"
                               th:field="*{marksPerQuestion}"
                               min="1"
                               max="10"
                               placeholder="e.g., 1"
                               required
                               class="form-control" />
                        <small class="form-text">Minimum 1 mark per question</small>
                    </div>

                    <!-- Tab Switch Limit -->
                    <div class="form-group">
                        <label for="tabSwitchLimit">
                            <i class="bx bx-tab"></i> Tab Switch Limit *
                        </label>
                        <input type="number"
                               id="tabSwitchLimit"
                               th:field="*{tabSwitchLimit}"
                               min="0"
                               max="50"
                               placeholder="e.g., 3"
                               required
                               class="form-control" />
                        <small class="form-text">
                            <i class="bx bx-info-circle"></i>
                            Set to 0 for unlimited tab switches
                        </small>
                    </div>

                    <!-- Submit Button -->
                    <button type="submit" class="btn btn-primary" style="width: 100%;">
                        <i class="bx bx-plus-circle"></i> Create Test
                    </button>
                </form>
            </div>
        </div>

        <!-- Test Results Section -->
        <div id="results-section" class="section-content" style="display: none;">
            <div class="content-section">
                <div class="section-header">
                    <h2 class="section-title">Test Results & Reports</h2>
                    <button class="btn btn-success" onclick="alert('Export functionality coming soon!')">
                        <i class="bx bx-download"></i> Download All Reports
                    </button>
                </div>
                <div class="search-bar">
                    <form onsubmit="event.preventDefault(); alert('Filter functionality coming soon!')">
                        <input type="text" name="query" placeholder="Search by Student ID or Name..." th:value="${filterQuery}">
                        <select name="subjectId">
                            <option value="">All Subjects</option>
                            <option th:each="subject : ${subjects}"
                                    th:value="${subject.id}"
                                    th:text="${subject.name}"
                                    th:selected="${subject.id == selectedSubjectId}">Subject</option>
                        </select>
                        <select name="status">
                            <option value="">All Status</option>
                            <option value="pass" th:selected="${selectedStatus == 'pass'}">Pass</option>
                            <option value="fail" th:selected="${selectedStatus == 'fail'}">Fail</option>
                        </select>
                        <button class="btn btn-primary" type="submit">
                            <i class="bx bx-filter"></i> Filter
                        </button>
                    </form>
                </div>
                <div class="table-container">
                    <table th:if="${not #lists.isEmpty(testResults)}">
                        <thead>
                        <tr>
                            <th>Student ID</th>
                            <th>Student Name</th>
                            <th>Subject</th>
                            <th>Score</th>
                            <th>Pass/Fail</th>
                            <th>Time Taken</th>
                            <th>Date</th>
                            <th>Actions</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="result : ${testResults}">
                            <td th:text="${result.studentId}">STD-001</td>
                            <td th:text="${result.studentName}">Name</td>
                            <td th:text="${result.subjectName}">Subject</td>
                            <td th:text="${result.score + '/' + result.totalMarks}">0/100</td>
                            <td>
                                <span class="status-badge"
                                      th:classappend="${result.passed ? 'status-pass' : 'status-fail'}"
                                      th:text="${result.passed ? 'Pass' : 'Fail'}">Pass</span>
                            </td>
                            <td th:text="${result.timeTaken + ' min'}">0 min</td>
                            <td th:text="${#temporals.format(result.testDate, 'MMM dd, yyyy')}">Date</td>
                            <td>
                                <div class="action-buttons">
                                    <button class="action-btn btn-primary" title="Print Score"
                                            onclick="alert('Print functionality coming soon!')">
                                        <i class="bx bx-printer"></i>
                                    </button>
                                    <button class="action-btn btn-success" title="Download PDF"
                                            onclick="alert('Download PDF functionality coming soon!')">
                                        <i class="bx bx-download"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                    <div th:if="${#lists.isEmpty(testResults)}" class="empty-state">
                        <i class="bx bx-file"></i>
                        <h3>No Test Results Found</h3>
                        <p>No test results match your search criteria</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Question Bank Section -->
        <div id="questions-section" class="section-content" style="display: none;">
            <div class="content-section">
                <div class="section-header">
                    <h2 class="section-title">Question Bank Management</h2>
                    <button class="btn btn-primary" onclick="openModal('uploadQuestionsModal')">
                        <i class="bx bx-upload"></i> Upload Questions
                    </button>
                </div>
                <div class="table-container">
                    <table th:if="${not #lists.isEmpty(questionBanks)}">
                        <thead>
                        <tr>
                            <th>Subject</th>
                            <th>File Name</th>
                            <th>Total Questions</th>
                            <th>Last Updated</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="bank : ${questionBanks}">
                            <td th:text="${bank.subjectName}">Subject</td>
                            <td th:text="${bank.fileName}">file.csv</td>
                            <td th:text="${bank.totalQuestions}">0</td>
                            <td th:text="${#temporals.format(bank.lastUpdated, 'MMM dd, yyyy')}">Date</td>
                            <td>
                                <span class="status-badge status-pass"
                                      th:text="${bank.active ? 'Active' : 'Inactive'}">Active</span>
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <button class="action-btn btn-primary" title="View Questions"
                                            onclick="alert('View questions functionality coming soon!')">
                                        <i class="bx bx-show"></i>
                                    </button>
                                    <button class="action-btn btn-success" title="Download"
                                            onclick="alert('Download functionality coming soon!')">
                                        <i class="bx bx-download"></i>
                                    </button>
                                    <button class="action-btn btn-danger" title="Delete"
                                            th:onclick="'deleteQuestionBank(' + ${bank.id} + ')'">
                                        <i class="bx bx-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                    <div th:if="${#lists.isEmpty(questionBanks)}" class="empty-state">
                        <i class="bx bx-question-mark"></i>
                        <h3>No Question Banks Found</h3>
                        <p>Upload your first question bank to get started</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Subjects Section -->
        <div id="subjects-section" class="section-content" style="display: none;">
            <div class="content-section">
                <div class="section-header">
                    <h2 class="section-title">Subject Management</h2>
                    <button class="btn btn-primary" onclick="openModal('addSubjectModal')">
                        <i class="bx bx-plus"></i> Add New Subject
                    </button>
                </div>
                <div th:if="${not #lists.isEmpty(allSubjects)}">
                    <div class="subject-card" th:each="subject : ${allSubjects}">
                        <div class="subject-info">
                            <div class="subject-icon">
                                <i class="bx bx-book"></i>
                            </div>
                            <div class="subject-details">
                                <h4 th:text="${subject.name}">Subject Name</h4>
                                <p>
                                    <span th:text="${subject.totalQuestions}">0</span> Questions •
                                    <span th:text="${subject.studentsEnrolled}">0</span> Students Enrolled
                                </p>
                            </div>
                        </div>
                        <div class="action-buttons">
<!--                            <button class="action-btn btn-primary" title="View Details"-->
<!--                                    onclick="alert('View details functionality coming soon!')">-->
<!--                                <i class="bx bx-show"></i>-->
<!--                            </button>-->
                            <button class="action-btn btn-secondary" title="Edit"
                                    onclick="alert('Edit functionality coming soon!')">
                                <i class="bx bx-edit"></i>
                            </button>
                            <button class="action-btn btn-danger" title="Delete"
                                    th:onclick="'deleteSubject(' + ${subject.id} + ')'">
                                <i class="bx bx-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div th:if="${#lists.isEmpty(allSubjects)}" class="empty-state">
                    <i class="bx bx-book"></i>
                    <h3>No Subjects Found</h3>
                    <p>Add your first subject to start creating tests</p>
                </div>
            </div>
        </div>

        <!-- Analytics Section -->
        <div id="reports-section" class="section-content" style="display: none;">
            <div class="content-section">
                <div class="section-header">
                    <h2 class="section-title">Analytics & Reports</h2>
                    <button class="btn btn-success" onclick="alert('Export analytics functionality coming soon!')">
                        <i class="bx bx-download"></i> Export Analytics
                    </button>
                </div>
                <div class="overview-boxes" style="margin-bottom: 20px;">
                    <div class="box">
                        <div class="left-side">
                            <div class="box-topic">Avg. Score</div>
                            <div class="number" th:text="${analytics.avgScore + '%'}">0%</div>
                            <div class="indicator">
                                <i class="bx bx-up-arrow-alt"></i>
                                <span class="text" th:text="${analytics.scoreChange}">+0% this month</span>
                            </div>
                        </div>
                        <i class="bx bx-trending-up cart"></i>
                    </div>
                    <div class="box">
                        <div class="left-side">
                            <div class="box-topic">Completion Rate</div>
                            <div class="number" th:text="${analytics.completionRate + '%'}">0%</div>
                            <div class="indicator">
                                <i class="bx bx-up-arrow-alt"></i>
                                <span class="text" th:text="${analytics.completionChange}">+0% this month</span>
                            </div>
                        </div>
                        <i class="bx bx-check-circle cart two"></i>
                    </div>
                    <div class="box">
                        <div class="left-side">
                            <div class="box-topic">Avg. Time</div>
                            <div class="number" th:text="${analytics.avgTime + ' min'}">0 min</div>
                            <div class="indicator">
                                <i class="bx bx-down-arrow-alt down"></i>
                                <span class="text" th:text="${analytics.timeChange}">-0 min this month</span>
                            </div>
                        </div>
                        <i class="bx bx-time cart three"></i>
                    </div>
                    <div class="box">
                        <div class="left-side">
                            <div class="box-topic">Top Performer</div>
                            <div class="number" style="font-size: 18px;" th:text="${analytics.topPerformer}">N/A</div>
                            <div class="indicator">
                                <i class="bx bx-up-arrow-alt"></i>
                                <span class="text" th:text="${analytics.topPerformerScore + '% avg score'}">0% avg score</span>
                            </div>
                        </div>
                        <i class="bx bx-crown cart four"></i>
                    </div>
                </div>
                <h3 style="margin-top: 30px; margin-bottom: 15px; color: #333;">Subject-wise Performance</h3>
                <div class="table-container">
                    <table th:if="${not #lists.isEmpty(subjectPerformance)}">
                        <thead>
                        <tr>
                            <th>Subject</th>
                            <th>Total Tests</th>
                            <th>Avg. Score</th>
                            <th>Pass Rate</th>
                            <th>Avg. Time</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="perf : ${subjectPerformance}">
                            <td th:text="${perf.subjectName}">Subject</td>
                            <td th:text="${perf.totalTests}">0</td>
                            <td th:text="${perf.avgScore + '%'}">0%</td>
                            <td th:text="${perf.passRate + '%'}">0%</td>
                            <td th:text="${perf.avgTime + ' min'}">0 min</td>
                        </tr>
                        </tbody>
                    </table>
                    <div th:if="${#lists.isEmpty(subjectPerformance)}" class="empty-state">
                        <i class="bx bx-bar-chart-alt-2"></i>
                        <h3>No Analytics Data Available</h3>
                        <p>Analytics will appear once students start taking tests</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer-fab" id="footerFab">
            <img th:src="@{/images/tts-logo-ev.png}" alt="TTS" />
        </div>

        <footer id="popupFooter">
            <div class="footer-container">
                <div class="footer-col about">
                    <h3>TechnoKraft <br><span>Training & Solution Pvt. Ltd.</span></h3>
                    <p>Empowering careers through innovative technical training and real-world IT solutions. Building the next generation of developers, testers, and professionals.</p>
                </div>

                <div class="footer-col contact">
                    <h4>Contact Us</h4>
                    <ul>
                        <li><i class="fa-solid fa-phone"></i> 08645628278</li>
                        <li><i class="fa-solid fa-envelope"></i> info@tts.net.in</li>
                        <li><i class="fa-solid fa-clock"></i> 09:30 am - 08:30 pm</li>
                        <li><i class="fa-solid fa-location-dot"></i> 1st Floor, Kanchwala Avenue, Above Viju's Dabeli,<br>Thatte Nagar Marg, College Road, Nashik, Maharashtra 422005</li>
                    </ul>
                </div>

                <div class="footer-col links">
                    <h4>Quick Links</h4>
                    <ul>
                        <li><a href="#" onclick="event.preventDefault(); alert('Page coming soon!')">About Us</a></li>
                        <li><a href="#" onclick="event.preventDefault(); alert('Page coming soon!')">Courses</a></li>
                        <li><a href="#" onclick="event.preventDefault(); alert('Page coming soon!')">Placements</a></li>
                        <li><a href="#" onclick="event.preventDefault(); alert('Page coming soon!')">Contact</a></li>
                    </ul>
                </div>

                <div class="footer-col social">
                    <h4>Follow Us</h4>
                    <div class="social-icons">
                        <a href="https://www.linkedin.com/company/technokraft-training" target="_blank"><i class="fa-brands fa-linkedin"></i></a>
                        <a href="https://www.youtube.com/@technokrafttraining" target="_blank"><i class="fa-brands fa-youtube"></i></a>
                        <a href="https://www.instagram.com/technokraft_training" target="_blank"><i class="fa-brands fa-instagram"></i></a>
                    </div>
                </div>
            </div>

            <div class="footer-bottom">
                © 2025 TechnoKraft Training & Solution Pvt. Ltd. | All Rights Reserved
            </div>
        </footer>

    </div>

</section>

<!-- Add Student Modal -->
<div id="addStudentModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Add New Student</h2>
            <span class="close" onclick="closeModal('addStudentModal')">&times;</span>
        </div>

        <!-- Error Message Display -->
        <div th:if="${studentError}" class="error-message" style="margin-bottom: 15px;">
            <i class="bx bx-error-circle"></i>
            <span th:text="${studentError}">Error</span>
        </div>

        <!-- Success Message Display -->
        <div th:if="${success != null and #strings.contains(success, 'Student')}" class="success-message" style="margin-bottom: 15px;">
            <i class="bx bx-check-circle"></i>
            <span th:text="${success}">Success</span>
        </div>

        <form th:action="@{/admin/students/add}" method="post" th:object="${studentDTO}">
            <!-- CSRF Token -->
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

            <!-- Full Name Field -->
            <div class="form-group">
                <label for="studentFullName">Full Name *</label>
                <input type="text"
                       id="studentFullName"
                       name="fullName"
                       th:field="*{fullName}"
                       placeholder="Enter full name"
                       required
                       minlength="3"
                       maxlength="100"
                       pattern="[a-zA-Z\s]+"
                       title="Full name can only contain letters and spaces">
                <small class="form-text">Minimum 3 characters, letters and spaces only</small>
            </div>

            <!-- Email Field -->
            <div class="form-group">
                <label for="studentEmail">Email Address *</label>
                <input type="email"
                       id="studentEmail"
                       name="email"
                       th:field="*{email}"
                       placeholder="Enter email address"
                       required
                       maxlength="100"
                       title="Please provide a valid email address">
                <small class="form-text">Must be a valid email address</small>
            </div>

            <!-- Password Field -->
            <div class="form-group">
                <label for="studentPassword">Password *</label>
                <input type="password"
                       id="studentPassword"
                       name="password"
                       th:field="*{password}"
                       placeholder="Enter password"
                       required
                       minlength="6"
                       maxlength="50"
                       title="Password must contain at least one uppercase, one lowercase, and one number">
                <small class="form-text">Min 6 characters, must include uppercase, lowercase, and number</small>
            </div>

            <!-- Confirm Password Field -->
            <div class="form-group">
                <label for="studentConfirmPassword">Confirm Password *</label>
                <input type="password"
                       id="studentConfirmPassword"
                       name="confirmPassword"
                       th:field="*{confirmPassword}"
                       placeholder="Re-enter password"
                       required
                       minlength="6"
                       maxlength="50"
                       title="Please confirm your password">
                <small class="form-text">Must match the password above</small>
            </div>

            <!-- Student ID (Auto-generated, Display Only) -->
            <div class="form-group">
                <label for="studentIdDisplay">Student ID</label>
                <input type="text"
                       id="studentIdDisplay"
                       placeholder="Auto-generated (STD-XXX)"
                       readonly
                       style="background: #f5f5f5; cursor: not-allowed;">
                <small class="form-text">Will be automatically generated upon creation</small>
            </div>

            <!-- Active Status -->
            <div class="form-group" style="display: flex; align-items: center; gap: 10px;">
                <input type="checkbox"
                       id="studentEnabled"
                       name="enabled"
                       th:field="*{enabled}"
                       checked
                       style="width: auto; margin: 0;">
                <label for="studentEnabled" style="margin: 0; cursor: pointer;">Active Student</label>
            </div>

            <!-- Submit Button -->
            <button type="submit" class="btn btn-primary" style="width: 100%;">
                <i class="bx bx-plus"></i> Create Student
            </button>
        </form>
    </div>
</div>

<!-- Upload Questions Modal -->
<div id="uploadQuestionsModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Upload Question Bank</h2>
            <span class="close" onclick="closeModal('uploadQuestionsModal')">&times;</span>
        </div>

        <!-- Error Message Display -->
        <div th:if="${uploadError}" class="error-message" style="margin-bottom: 15px;">
            <i class="bx bx-error-circle"></i>
            <span th:text="${uploadError}">Error</span>
        </div>

        <!-- Success Message Display -->
        <div th:if="${success != null and #strings.contains(success, 'questions')}"
             class="success-message" style="margin-bottom: 15px;">
            <i class="bx bx-check-circle"></i>
            <span th:text="${success}">Success</span>
        </div>

        <!-- CSV Format Instructions -->
        <div style="background: #f0f8ff; border-left: 4px solid #0066cc; padding: 15px; margin-bottom: 20px; border-radius: 4px;">
            <h4 style="margin: 0 0 10px 0; color: #0066cc;">
                <i class="bx bx-info-circle"></i> CSV Format Requirements
            </h4>
            <p style="margin: 5px 0; font-size: 14px; color: #333;">
                Your CSV file must include the following columns in order:
            </p>
            <ol style="margin: 10px 0 10px 20px; font-size: 13px; color: #555;">
                <li><strong>Question</strong> - The question text (required)</li>
                <li><strong>Option A</strong> - First option (required)</li>
                <li><strong>Option B</strong> - Second option (required)</li>
                <li><strong>Option C</strong> - Third option (required)</li>
                <li><strong>Option D</strong> - Fourth option (required)</li>
                <li><strong>Correct Answer</strong> - A, B, C, or D (required)</li>
                <li><strong>Explanation</strong> - Answer explanation (optional)</li>
                <li><strong>Marks</strong> - Points (1-10, default: 1, optional)</li>
                <li><strong>Difficulty</strong> - EASY/MEDIUM/HARD (default: MEDIUM, optional)</li>
            </ol>
            <a href="/sample-question-bank.csv" download style="color: #0066cc; text-decoration: none; font-size: 13px;">
                <i class="bx bx-download"></i> Download Sample CSV Template
            </a>
        </div>

        <form th:action="@{/admin/questions/upload}"
              method="post"
              enctype="multipart/form-data"
              th:object="${questionBankDTO}">

            <!-- CSRF Token -->
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

            <!-- Select Subject -->
            <div class="form-group">
                <label for="subjectId">Select Subject *</label>
                <select id="subjectId"
                        name="subjectId"
                        th:field="*{subjectId}"
                        required
                        style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="">-- Choose a subject --</option>
                    <option th:each="subject : ${subjects}"
                            th:value="${subject.id}"
                            th:text="${subject.name}">Subject</option>
                </select>
                <small class="form-text">Select the subject for these questions</small>
            </div>

            <!-- Description (Optional) -->
            <div class="form-group">
                <label for="questionBankDescription">Description (Optional)</label>
                <textarea id="questionBankDescription"
                          name="description"
                          th:field="*{description}"
                          placeholder="Brief description of this question bank (e.g., Chapter 1-5 Questions)"
                          maxlength="500"
                          rows="3"
                          style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; resize: vertical;"></textarea>
                <small class="form-text">Maximum 500 characters (optional)</small>
            </div>

            <!-- File Upload -->
            <div class="form-group">
                <label for="csvFile">Upload CSV File *</label>
                <div class="file-upload-area"
                     onclick="document.getElementById('csvFile').click()"
                     id="fileUploadArea"
                     style="border: 2px dashed #ddd; border-radius: 8px; padding: 30px; text-align: center; cursor: pointer; background: #fafafa; transition: all 0.3s;">
                    <i class="bx bx-cloud-upload" style="font-size: 48px; color: #999;"></i>
                    <p id="fileUploadText" style="margin-top: 10px; color: #666; font-size: 14px;">
                        Click to upload or drag and drop
                    </p>
                    <p style="font-size: 12px; color: #999; margin-top: 5px;">
                        CSV files only (Max 5MB)
                    </p>
                </div>
                <input type="file"
                       id="csvFile"
                       name="file"
                       accept=".csv"
                       required
                       style="display: none;"
                       onchange="updateFileName(this)">
                <small class="form-text">Only .csv files are accepted</small>
            </div>

            <!-- Submit Button -->
            <button type="submit" class="btn btn-primary" style="width: 100%; padding: 12px;">
                <i class="bx bx-upload"></i> Upload Question Bank
            </button>
        </form>
    </div>
</div>

<!-- Add Subject Modal - COMPLETE VERSION -->
<div id="addSubjectModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Add New Subject</h2>
            <span class="close" onclick="closeModal('addSubjectModal')">&times;</span>
        </div>

        <!-- Error Message Display -->
        <div th:if="${subjectError}" class="error-message" style="margin-bottom: 15px;">
            <i class="bx bx-error-circle"></i>
            <span th:text="${subjectError}">Error</span>
        </div>

        <!-- Success Message Display -->
        <div th:if="${success}" class="success-message" style="margin-bottom: 15px;">
            <i class="bx bx-check-circle"></i>
            <span th:text="${success}">Success</span>
        </div>

        <form th:action="@{/admin/subjects/add}" method="post" th:object="${subjectDTO}">
            <!-- CSRF Token -->
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

            <!-- Subject Name Field -->
            <div class="form-group">
                <label for="name">Subject Name *</label>
                <input type="text"
                       id="name"
                       name="name"
                       th:field="*{name}"
                       placeholder="Enter subject name (e.g., Core Java)"
                       required
                       minlength="3"
                       maxlength="100"
                       title="Subject name must contain only letters and spaces">
                <small class="form-text">Minimum 3 characters, maximum 100 characters</small>
            </div>

            <!-- Subject Code Field - THIS WAS MISSING! -->
            <div class="form-group">
                <label for="subjectCode">Subject Code *</label>
                <input type="text"
                       id="subjectCode"
                       name="subjectCode"
                       th:field="*{subjectCode}"
                       placeholder="e.g., JAVA-101"
                       required
                       minlength="3"
                       maxlength="20"
                       pattern="[A-Z0-9-]+"
                       style="text-transform: uppercase;"
                       title="Subject code must contain only uppercase letters, numbers, and hyphens">
                <small class="form-text">Use uppercase letters, numbers, and hyphens only (e.g., JAVA-101)</small>
            </div>

            <!-- Description Field - THIS WAS MISSING! -->
            <div class="form-group">
                <label for="description">Description</label>
                <textarea
                        id="description"
                        name="description"
                        th:field="*{description}"
                        placeholder="Brief description of the subject (optional)"
                        maxlength="500"
                        rows="3"
                        style="resize: vertical;"></textarea>
                <small class="form-text">Maximum 500 characters (optional)</small>
            </div>

            <!-- Active Checkbox -->
            <div class="form-group" style="display: flex; align-items: center; gap: 10px;">
                <input type="checkbox"
                       id="active"
                       name="active"
                       th:field="*{active}"
                       checked
                       style="width: auto; margin: 0;">
                <label for="active" style="margin: 0; cursor: pointer;">Active Subject</label>
            </div>

            <!-- Submit Button -->
            <button type="submit" class="btn btn-primary" style="width: 100%;">
                <i class="bx bx-plus"></i> Create Subject
            </button>
        </form>
    </div>
</div>

<!-- Delete Confirmation Form (Hidden) - Disabled for now -->
<form id="deleteForm" method="post" style="display:none;">
    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
    <input type="hidden" name="_method" value="DELETE"/>
</form>

<script>
    function updateTestName() {
    const subjectSelect = document.getElementById('subjectName');
    const testTypeSelect = document.getElementById('testType');

    if (subjectSelect && testTypeSelect && subjectSelect.value && testTypeSelect.value) {
        const testType = testTypeSelect.value === 'FINAL' ? 'Final Test' : 'Mock Test';
        const generatedName = `${subjectSelect.value} ${testType}`;
        console.log('Generated test name:', generatedName);
    }
}
/**
 * Delete Test Function
 */
function deleteTest(testId) {
    if (!confirm('Are you sure you want to delete this test? This action cannot be undone.')) {
        return;
    }

    // Get CSRF token
    const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

    // Send DELETE request
    fetch(`/admin/tests/${testId}/delete`, {
        method: 'POST',
        headers: {
            [csrfHeader]: csrfToken,
            'Content-Type': 'application/json'
        }
    })
    .then(response => {
        if (response.ok) {
            alert('Test deleted successfully!');
            window.location.reload();
        } else {
            return response.text().then(text => {
                throw new Error(text || 'Failed to delete test');
            });
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error deleting test: ' + error.message);
    });
}

/**
 * Show Section Function (if not already present)
 */
function showSection(sectionName) {
    // Hide all sections
    const sections = document.querySelectorAll('.section-content');
    sections.forEach(section => {
        section.style.display = 'none';
    });

    // Remove active class from all nav links
    const navLinks = document.querySelectorAll('.nav-links a');
    navLinks.forEach(link => {
        link.classList.remove('active');
    });

    // Show selected section
    const targetSection = document.getElementById(sectionName + '-section');
    if (targetSection) {
        targetSection.style.display = 'block';
    }

    // Add active class to clicked nav link
    event.target.closest('a').classList.add('active');
}

/**
 * Open Modal Function (if not already present)
 */
function openModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.style.display = 'block';
    }
}

/**
 * Close Modal Function (if not already present)
 */
function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.style.display = 'none';
    }
}

// Close modal when clicking outside
window.onclick = function(event) {
    if (event.target.classList.contains('modal')) {
        event.target.style.display = 'none';
    }
}

    // Add this to the end of your admin-dashboard.js file

// Auto-show modals if there are errors
document.addEventListener('DOMContentLoaded', function() {

    // Auto-show modal if there's a test error
    const hasTestError = /*[[${testError}]]*/ null;
    if (hasTestError) {
        openModal('createTestModal');
        showSection('create-test'); // Also switch to create-test section
    }

    // Auto-show modal if there's a subject error
    const hasSubjectError = /*[[${subjectError}]]*/ null;
    if (hasSubjectError) {
        openModal('addSubjectModal');
    }

    // Auto-show modal if there's a student error
    const hasStudentError = /*[[${studentError}]]*/ null;
    if (hasStudentError) {
        openModal('addStudentModal');
    }

    // Auto-show modal if there's an upload error
    const hasUploadError = /*[[${uploadError}]]*/ null;
    if (hasUploadError) {
        openModal('uploadQuestionsModal');
    }

    console.log('Modal auto-open initialized');
});

</script>

<!-- JavaScript -->
<script th:src="@{/js/footer.js}"></script>
<script th:src="@{/js/admin-dashboard.js}"></script>


</body>
</html>